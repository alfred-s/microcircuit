\section{Results}
\label{sec:results}

\subsection{Spiking network model}
The simulation of the spiking network model will be analyzed in the following manner. 
At first, the results are directly compared to those obtained by the original 
model of Potjans and Diesmann. Both simulations are run for the same parameters, 
differences arise solely due to internal differences in assigning the random 
number generators. It is therefor not feasible to do a direct (spike per spike) 
comparison. Instead, a statistical description is chosen which furthermore sheds light
onto the differences between individual realizations with different seeds for the 
random number generators. Certain aspects such as
the distribution of single neuron firing rate within the population, 
the interspike interval distributions and the global population activity 
are then analyzed more thoroughly. Some of these  results are compared with 
theoretical approximations, namely the resulting distributions 
for Poisson processes.

A comparison between the pyNEST implementation and the original one written in SLI
is first supplied in form of raster plots (Figure~\ref{fig:raster_plot}), 
showing the activity of a subset of the neurons simulated for 400 ms 
after a transient period of 100 ms. The subset shown consists of the first 
$2.5 \%$ of the neurons created during the creation of the network. 
Both results have a very similar structure: Common features are the observable low 
rates of populations $L2/3e$ and $L6e$ as well some signs of synchrony within populations. 
Single neurons fire at a rate much lower than the activity of the 
entire population, as would be expected for networks in the AI regime \cite{brunel2000}. 
\begin{figure}[htpb]
    \centering
    \includegraphics[width=1.0\linewidth]{\figdir raster_plot}
    \caption{Raster plot showing spontaneous activity of network for 
        (A) the pyNEST implementation and (B) the SLI implementation.
        The simulation and network parameters for both simulations are 
        the same. 
        For each layer, the excitatory population is the upper one shown 
        (total of 1924 neurons) for $400$ ms (with a transient period of 100 ms). 
    }
    \label{fig:raster_plot}
\end{figure}

A more thorough comparison is done on the bases of three statistical quantities: 
Figure~\ref{fig:spontaneous_activity} shows the population means of single neurons firing rates, 
the coefficient of variation of interspike intervals (CV of ISI) as well as a measure for synchrony for both 
simulations. All parameters were calculated from $10$ repetitions of a simulation for 
$60.2$ s. Spikes were recorded from $1000$ neurons of each population, with recording 
starting after a transient period of $0.2$ s. 
For all three aspects, the agreement between the two implementations is very good 
and well within statistical fluctuations. 
The means are obtained by calculating the single neuron firing rates as 
the number of spikes measured over the time measured and then taking the mean over the entire population. 
\emph{ASSUMPTION: The box plot further shows that 
fluctuations relative to the mean are roughly equal for all populations, with outliers lying 
up to $\pm 10 \%$ above or below the median. Thus, the highest absolute fluctuations are observed 
for the layers $L5e, L5i$ and $L6i$.} 

The CV of ISI is calculated for each neuron that fired more than twice.
Although the results of both implementations agree, there is a disagreement with the results presented 
in the original paper, where a CV of ISI larger 0.8 for all populations is stated
under similar simulation conditions\cite{potjans2014}. 
This might be due to a difference in calculating the CV of ISI, for instance excluding neurons 
with particularly low firing rates. 
Especially 
for the populations with low rates ($L2/3e, L6e$), the finite simulation time leads to an estimation bias
of the CV of ISI as a significant ratio of the neurons in the population is either not included at all 
($n_i < 2$) or the part of the distribution covering higher CV of ISIs is not represented well~%
\cite{grun2010analysis}. 
\\\emph{IS THERE anything to be said about fluctuations?}

The synchrony measure explores the activity of each population as a whole. The respective population
activity is calculated by subdividing the time of measurement into equal bins (bin width = $3$ ms) 
and counting the number of spikes within each bin for each population. 
Dividing the variance by the squared mean yields the synchrony measure. 
A population firing totally asynchronously would yield a synchrony of zero as there would 
be no global oscillations i.~e. zero variance observed.
As with the CV of ISI, the results of both implementations agree, but do not reproduce the ones stated 
by Potjans and Diesmann \cite{potjans2014}. 
\\\emph{CAN THIS be traced back to the fact that they used 
only 5 s of simulation? -> methods: check synchrony for measurement time and bin width!}. 
\begin{figure}[htpb]
    \centering
    \includegraphics[width=1.0\linewidth]{\figdir spontaneous_activity}
    \caption{
        Derived statistical quantities for spontaneous activity of network for
        (\textbf{A - C}) the pyNEST implementation and (\textbf{D - E}) the SLI implementation, 
        using the same simulation and network parameters.
        Each implementation is run $20$ times independently, 
        measuring 1000 spike trains of each population in a simulation for 60 s 
        after a transient period of 0.2 s. 
        Statistical fluctuations 
        are indicated by the interquartile ranges (boxes extend to Q1 and Q3). 
        The median is indicated by a black line, the population mean by a star and 
        whiskers extend to 1.5 IQR (outliers indicated by crosses). 
        \quad (\textbf{A, D}) 
        \quad (\textbf{B, E}) Population mean of Coefficient of variation (CV) of interspike intervals (ISI) indicating 
        the irregularity of single neuron spiking. 
        \quad (\textbf{C, F}) Synchrony of the recorded subset of each population quantified by the 
        variance of the summed spike count histograms (bin width 3 ms) divided by
        its mean. 
    }
    \label{fig:spontaneous_activity}
\end{figure}

In order to get a deeper insight into the dynamics of the simulated network, the single neuron firing 
rates and the CV of ISI of single neurons are examined in Figure \ref{fig:single_neuron_activity}.
The observed fluctuations around the population mean are remarkably large especially when compared 
to the fluctuations of the population mean for different realizations. This can be interpreted as 
an indication that the population rates depend strongly on averaged input and connection numbers
and less on the actual wiring, i.~e. that a mean field approach would be able to capture the main features 
of first order quantities. 
\begin{figure}[htpb]
    \centering
    \includegraphics[width=1.0\linewidth]{\figdir single_neuron_activity}
    \caption{
        Firing rates (\textbf{A}) and CV of ISI (\textbf{B}) for single neurons. 
        The data is take from one simulation of the pyNEST implementation 
        simulating $60$ s after a transient period of 0.2 s and measuring 
        $1000$ neurons of each population. The symbols of the box plot 
        are similar to the ones of Figure \ref{fig:spontaneous_activity} 
        (boxes: Q1-Q3, median:black line, mean: star, 
        whiskers to 1.5 of IQR, outliers: crosses). 
        \\\emph{DISCUSSION?
        Both quantities show very large fluctuations. One of the suspected
        causes is the connection rule applied, yielding a binomial distribution 
        of synapse numbers within one population
        such that differences in input between single neurons can be 
    considerably large.}
    }
    \label{fig:single_neuron_activity}
\end{figure}

\emph{MORE DETAILED view on results:
Synchrony of populations in terms of population activity, 
see Appendix, Figure \ref{fig:population_activity}. 
The observed global oscillation indicates non-negligible correlations
and thus contradicts the assumption of uncorrelated gaussian white noise 
(in the mean field model).}

\subsection{Mean field theory}
The primary results of the mean field theory cut down to the prediction of 
population mean of single neuron firing rates and then using these rates 
in order to predict the CV of ISI and the distribution of membrane potentials. 
These results are directly compared to 
the corresponding quantities recorded from the spiking network 
model simulation analyzed in the previous sections. 

The predicted firing rates obtained by solving equation 
\eqref{eq:self_consistency_a} are displayed in a bar plot in Figure 
\ref{fig:compare_sim_mf_fixed_total_number}. Rates measured in 
simulation and previously stated in Figure \ref{fig:spontaneous_activity}
are shown for comparison. As visible, the results of the mean field model 
match those of the simulation qualitatively: The sequence of populations 
ordered by increasing firing rates is reproduced with the exception of
the two highest rates, i.~e. the two populations of layer $5$. 
The most apparent difference is the seen for the populations firing at the lowest 
rates, $L2/3e$  and $L6e$. The measured rates are almost equal while the 
predicted rates are very different, $r_{L6e} = 1.6$ Hz is almost three times 
as large as $r_{L2/3e}$. Another observable feature is that the predicted rates
for six of the eight populations are smaller than the measured ones. 
The comparison can further be quantified: The difference 
$    \Delta r_a := r_{\text{mf}, a} - r_{\text{sim}, a} $
between the mean of simulated rates $r_{\text{sim}, a}$ and predicted rates 
$r_{\text{mf}, a}$ for each population $a$ is shown in table \ref{tab:diff_fixed_total_number}. 
For the absolute values of all populations, mean and standard 
deviation are $(0.46 \pm  0.13)$ Hz. The relative differences 
are much larger for populations firing at low rate.  
The CV of ISI for each population is the result of plugging in the predicted rates 
into equation \eqref{eq:CV_ISI_mf}. A comparison with simulation data is shown
in Figure \ref{fig:compare_sim_mf_fixed_total_number}. Here the result turns out 
to be quite close to the measured one. In all cases, the mean field theory predicts 
a slightly higher variability. The larges deviation is again seen in the populations 
$L2/3e$ and $L6e$, those firing at the lowest rates. Ignoring these two populations, 
the theory further predicts the order of variability among the populations, although
the differences are small. As for the rates, numerical results are subsumed in 
Table \ref{tab:diff_fixed_total_number}, using analogous definitions. 
Averaged over all populations, the deviation between mean field theory and simulation
is $(0.06 \pm 0.04)$ corresponding to about $(6 \pm 5) \%$. 
\emph{
    Discuss these results in Discussion: origin of discrepancies:
    bad agreement for j02 = 2; larger rates: origin?
    CV of ISI: reason for deviation at low rates: bias in measurement / correlation?
}

% Table of results of comparison
\begin{table}[htpb]
    \centering
    \caption{Difference between predicted and simulated population means for single 
    neuron firing rates; absolute and relative to simulated rates.}
    \label{tab:diff_fixed_total_number}
    \begin{tabular}{p{2.4cm}| *{8}{x{1.12cm}}}
        \rowcolor{TableColor}
        Population $a$       
        & L2/3e & L2/3i & L4e & L4i & L5e & L5i & L6e & L6i  \tn[0.2cm]
        $\Delta r_a$ / Hz
            & -0.41 & -0.61 & -0.38 & -0.36 &  0.37 & -0.70 &  0.54 & -0.32 \tn[0.2cm]
        $\Delta r_a \:/\: r_{\text{sim}, a}$
            & -0.42 & -0.20 & -0.09 & -0.06 &  0.05 & -0.08 &  0.49 & -0.04 \tn[0.2cm]
        $\Delta \text{CV}_a$
            &  0.14 &  0.05 &  0.04 &  0.03 &  0.02 &  0.03 &  0.13 &  0.03 \tn[0.2cm]
        $\Delta \text{CV}_a / \text{CV}_{\text{sim}, a}$
            &  0.16 &  0.06 &  0.05 &  0.03 &  0.02 &  0.04 &  0.15 &  0.04 \tn[0.2cm]
    \end{tabular}
\end{table}

% Comparison mean field / simulation
\begin{figure}[htpb]
    \centering
    \includegraphics[width=0.8\linewidth]{\figdir compare_sim_mf_fixed_total_number}
    \caption{
        Comparison between mean field theory and spiking network model. 
        Bars indicate the single neuron firing rates predicted by the mean field 
        theory, crosses the calculated ones of 20 simulation (as previously shown in
        Figure \ref{fig:simulation_activity}). The connection
        rule was set to "fixed\_total\_number".
        Comparison between mean field theory and spiking network model.
    }
    \label{fig:compare_sim_mf_fixed_total_number}
\end{figure}

Applying equation \eqref{eq:P_V_a} on the predicted rates yields the 
membrane potential distributions shown in 
Figure \ref{fig:membrane_potential}. 
The obtained distributions  are confronted with the normalized histograms of recorded 
membrane potentials of a subpopulation of $n_\text{rec} = 100$ neurons for 
each population. The contribution due to neurons in refractory period is removed
(see Analysis in Methods, \ref{subsec:analysis} for details). 
Similar to the firing rates, 
the agreement is quite good and the largest deviations are observable for  
the populations $L2/3e$ and $L6e$, corresponding to the lowest firing rates and
largest relative differences as calculated before. A common feature found for all
populations is that the predicted distributions are narrower than the recorded ones.
Furthermore, the predicted maximum is shifted towards the threshold. The effect
of neurons coming out of refractory period is underestimated in some cases, 
visible for example in populations $L2/3i$ and $L4i$ where the mean distributions 
show a step while the kink in the theoretical curves is hardly detectable. 
In the case of population $L5i$ and $L6i$, however, this behavior is captured well. 

% Membrane potentials
\begin{figure}[htpb]
    \centering
    \includegraphics[width=0.8\linewidth]{\figdir membrane_potential}
    \caption{
        Distribution of membrane potentials for each population. 
        Shown are both the results of simulation (histogram) and 
        the predictions of the mean field theory (continuous line). 
        The simulation results are histograms (bins width $\Delta V_\text{m} = 0.25$ mV) 
        of membrane potential recordings 
        of 100 neurons, recorded every 1.0 ms for a simulation time of 1.0 s 
        (after a transitional period of 0.2 s), 
        adjusted for neurons in refractory period (see text). 
        The binning in voltage is the same as applied in Figure 
        \ref{fig:single_membrane_potential}. 
        The voltage for neurons in refractory period $V_\text{r} = -65$ mV 
        is indicated by the dashed and dotted line. The threshold is at 
        $\theta = -50$ mV. 
    }
    \label{fig:membrane_potential}
\end{figure}

\subsection{Simulation closer to mean field theory }
In order to assess some of the discrepancies between the predictions of the mean field 
model and data from simulation, a number of parameters in the simulation are adjusted 
such that they resemble the ones chosen in the mean field theory more closely. 
Differentiating parameters in the previous comparison are listed in the 
Table~\ref{tab:diff_params}.
\begin{table}[htpb]
    \centering
    \caption{Parameters chosen differently between simulation and mean field model previously.}
    \label{tab:diff_params}
    \begin{tabular}{p{3.0cm} *{2}{|p{5.3cm}}}
        \rowcolor{TableColor}
        Parameter & Simulation & Mean field theory   \tn[0.2cm] 
        Network size &
            finite; $N_a$ & 
            none (neglecting finite size effects)
            \tn[0.1cm] %\hline
        Connection rule & 
        "fixed\_total\_number"; binomial distribution of synapse numbers & 
            "fixed\_indegree"; same synapse number per neuron 
            \tn[0.1cm] %\hline
        Synapse type & 
            current based &
            voltage based
            \tn[0.1cm] %\hline
        Synaptic weights & 
            clipped normal distribution & 
            Dirac delta distribution 
            \tn[0.1cm]
    \end{tabular}
\end{table}

\emph{Simulation with parameters adapted are on their way...}

